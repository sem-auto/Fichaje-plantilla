<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje con foto</title>
<style>
  :root { --gap:14px; --r:16px; --w:560px; --btnH:48px; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Arial,sans-serif;background:#f4f6f8;color:#111;min-height:100dvh;display:grid;place-items:center}
  .card{width:100%;max-width:var(--w);background:#fff;border-radius:var(--r);box-shadow:0 6px 24px rgba(0,0,0,.08);padding:16px}
  .row{display:flex;gap:var(--gap);align-items:center;margin-bottom:var(--gap)}
  .row>label{min-width:96px;font-weight:600}
  input,select{width:100%;padding:10px 12px;border:1px solid #d7dde4;border-radius:10px;font-size:16px}
  video,canvas{width:100%;border-radius:12px;background:#000}
  button{height:var(--btnH);border:0;border-radius:12px;font-weight:700;cursor:pointer}
  .primary{background:#2563eb;color:#fff;width:100%}
  .secondary{background:#e5e7eb;color:#111;width:100%;margin-top:8px}
  .status{height:40px;display:flex;align-items:center;justify-content:center;font-weight:600}
  .ok{color:#0a7f2e}.err{color:#b00020}
  .hint{font-size:12px;color:#555}
</style>
</head>
<body>
  <div class="card">
    <h2>Fichaje con foto</h2>

    <div class="row">
      <label>Nombre</label>
      <input id="nombre" placeholder="Nombre y apellidos" autocomplete="name" />
    </div>

    <div class="row">
      <label>Tipo</label>
      <select id="tipo">
        <option value="entrada">entrada</option>
        <option value="salida">salida</option>
      </select>
    </div>

    <div class="row">
      <label>Sin pausa</label>
      <input type="checkbox" id="sinPausa" />
    </div>

    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas" hidden></canvas>
    <input id="file" type="file" accept="image/*" capture="user" hidden />

    <button class="secondary" id="btnCam">Activar cámara</button>
    <div class="hint">Si no hay cámara o está bloqueada, se enviará sin foto.</div>

    <div style="height:12px"></div>
    <button class="primary" id="btn">Fichar con foto</button>
    <div class="status" id="status"></div>
  </div>

<script>
/** CONFIG **/
const ENDPOINT = 'PON_AQUI_TU_URL_WEBAPP/exec';  // GAS Web App “Cualquiera, incluso anónimo”
const TARGET_WIDTH = 640;
const JPEG_QUALITY = 0.6;

const el=id=>document.getElementById(id);
const video=el('video'), canvas=el('canvas'), btn=el('btn'), btnCam=el('btnCam'), fileInput=el('file'), statusEl=el('status');

let stream=null, audioUnlocked=false;

function setStatus(msg,isErr=false){ statusEl.textContent=msg; statusEl.className='status '+(isErr?'err':'ok'); }

function unlockAudioOnce(){
  if (audioUnlocked) return;
  try {
    const AC=window.AudioContext||window.webkitAudioContext;
    const a=new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination); g.gain.value=0; o.start(); o.stop(0); a.close();
    audioUnlocked=true;
  } catch(_) {}
}
function beepOk(){
  try{
    const AC=window.AudioContext||window.webkitAudioContext;
    const a=new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination);
    o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.06,a.currentTime);
    o.start(); setTimeout(()=>{o.stop(); a.close();},120);
  }catch(_){}
}

async function requestCamera(){
  try{
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('API no soportada');
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    video.srcObject = stream;
    await video.play().catch(()=>{});
    setStatus('Cámara lista');
    return true;
  }catch(e){
    stream = null;
    setStatus('Sin acceso a cámara', true);
    return false;
  }
}

function captureToDataURL(){
  if (!stream || !video.videoWidth || !video.videoHeight) return '';
  const vw=video.videoWidth, vh=video.videoHeight;
  const scale=TARGET_WIDTH/vw, tw=Math.round(vw*scale), th=Math.round(vh*scale);
  canvas.width=tw; canvas.height=th;
  const ctx=canvas.getContext('2d',{willReadFrequently:false});
  ctx.drawImage(video,0,0,tw,th);
  return canvas.toDataURL('image/jpeg', JPEG_QUALITY);
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>resolve(String(fr.result||''));
    fr.onerror=()=>reject(fr.error||new Error('read error'));
    fr.readAsDataURL(file);
  });
}

function jsonp(url, onDone){
  const cb='cb_'+Math.random().toString(36).slice(2);
  window[cb]=(data)=>{ try{ onDone(data); } finally{ delete window[cb]; s.remove(); } };
  const s=document.createElement('script');
  s.src=url+(url.includes('?')?'&':'?')+'callback='+cb;
  s.onerror=()=>{ try{ onDone({ok:false,error:'JSONP error'}); } finally{ delete window[cb]; s.remove(); } };
  document.head.appendChild(s);
}

async function postJSON(url, payload, timeoutMs=15000){
  const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),signal:ctrl.signal});
    const json=await res.json().catch(()=>({ok:false,error:'Respuesta inválida'}));
    return json;
  } finally { clearTimeout(to); }
}

function confirmReceipt(nombre, afterIso, attempts=8, delayMs=400){
  return new Promise((resolve)=>{
    const tryOnce=(left)=>{
      const u=`${ENDPOINT}?check=1&nombre=${encodeURIComponent(nombre)}&after=${encodeURIComponent(afterIso)}`;
      jsonp(u, (r)=>{
        if (r && r.ok){ resolve(true); }
        else if (left>1){ setTimeout(()=>tryOnce(left-1), delayMs); }
        else { resolve(false); }
      });
    };
    tryOnce(attempts);
  });
}

/* UI */
btnCam.addEventListener('click', async ()=>{
  unlockAudioOnce();
  await requestCamera();
});

btn.addEventListener('click', async ()=>{
  unlockAudioOnce();

  const nombre=(el('nombre').value||'').trim();
  const tipo=el('tipo').value;
  const sinPausa=el('sinPausa').checked;
  if(!nombre){ setStatus('Falta nombre', true); return; }

  const afterIso=new Date().toISOString();
  setStatus('Enviando…');

  // Fase 1: GET JSONP (fichaje rápido)
  const url = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&sinPausa=${sinPausa?'true':'false'}`;
  jsonp(url, async (r)=>{
    if(!r || !r.ok){ setStatus((r && (r.msg||r.error)) || 'Error', true); return; }

    // OK inmediato + beep
    setStatus(`OK ${r.hora}`);
    beepOk();

    // Fase 2: foto en background (opcional)
    try{
      let fotoDataURL = captureToDataURL();
      if (!fotoDataURL) {
        // fallback: abrir selector de archivo si no hay cámara
        fileInput.onchange = async () => {
          const f = fileInput.files[0];
          if (!f) return;
          const durl = await fileToDataURL(f).catch(()=> '');
          if (durl) await postJSON(ENDPOINT, { token: r.token, photo: durl });
        };
        fileInput.click();
      } else {
        await postJSON(ENDPOINT, { token: r.token, photo: fotoDataURL });
      }
    }catch(e){ /* silencioso */ }

    // Confirmación silenciosa (para logs)
    await confirmReceipt(nombre, afterIso, 8, 400);
  });
});

// no pedimos cámara en auto; se pide al pulsar “Activar cámara” (iOS exige gesto)
</script>
</body>
</html>
