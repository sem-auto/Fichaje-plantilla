<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Fichaje</title>
<style>
  :root{--bg:#edf0f3;--card:#fff;--ink:#111;--ok:#1fa354;--ok2:#168041;--err:#d33c3c;--err2:#a32e2e}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .wrap{max-width:980px;margin:14px auto;padding:12px;background:var(--card);border-radius:14px;box-shadow:0 2px 18px rgba(0,0,0,.08)}
  h1{margin:4px 0 10px;text-align:center;font-size:24px}
  .cam{width:100%;height:380px;background:#000;border-radius:10px;overflow:hidden}
  video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)} /* selfie */
  canvas{display:none}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .btn{display:block;width:100%;padding:14px 12px;border-radius:12px;border:none;font-weight:800;font-size:20px;color:#fff;cursor:pointer}
  .in{background:var(--ok)} .in:hover{background:var(--ok2)}
  .out{background:var(--err)} .out:hover{background:var(--err2)}
  .statusBox{margin-top:12px;background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:10px 12px;font-weight:800;display:flex;gap:8px;align-items:center}
  .statusBox.ok{border-color:#cfeeda;background:#f4fbf6;color:#125b31}
  .statusBox.err{border-color:#ffd1cf;background:#fff7f6;color:#8a2323}
  .muted{font-weight:600;color:#666;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Fichaje</h1>
    <div class="cam"><video id="cam" autoplay muted playsinline></video><canvas id="snap"></canvas></div>

    <div class="grid">
      <button class="btn in"  onclick="fichar('Ana López Martín','entrada')">Ana López Martín — Entrada</button>
      <button class="btn out" onclick="fichar('Ana López Martín','salida')">Ana López Martín — Salida</button>

      <button class="btn in"  onclick="fichar('Carla Gómez Torres','entrada')">Carla Gómez Torres — Entrada</button>
      <button class="btn out" onclick="fichar('Carla Gómez Torres','salida')">Carla Gómez Torres — Salida</button>

      <button class="btn in"  onclick="fichar('Luis Fernández Díaz','entrada')">Luis Fernández Díaz — Entrada</button>
      <button class="btn out" onclick="fichar('Luis Fernández Díaz','salida')">Luis Fernández Díaz — Salida</button>

      <button class="btn in"  onclick="fichar('Diego Pérez Ruiz','entrada')">Diego Pérez Ruiz — Entrada</button>
      <button class="btn out" onclick="fichar('Diego Pérez Ruiz','salida')">Diego Pérez Ruiz — Salida</button>
    </div>

    <div id="status" class="statusBox">
      <div id="sMain">Listo</div>
      <div class="muted" id="sSub"></div>
    </div>
  </div>

  <!-- Beep -->
  <audio id="beep" preload="auto"
    src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAAAABmZmZmZmZmZmZmZmYA"></audio>

<script>
/*** CONFIG ***/
const WEBAPP_URL='https://script.google.com/macros/s/AKfycbxlR17AJQw87pZgALcfRTE__1ud65aXrRj7B0OG7tu3Lj5s1bCsFRw09WS81qDa2Q-k/exec';

/*** Normaliza igual que el backend (tildes/espacios) ***/
function normalizeName(s){
  if(!s) return '';
  let n=String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'')
           .replace(/\s+/g,' ').trim().toLowerCase();
  return n.replace(/\b\w/g,c=>c.toUpperCase());
}
function hhmmss(){ return new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

/*** Cámara (user → fallback environment) ***/
(async function initCam(){
  const v=document.getElementById('cam');
  const a={video:{facingMode:'user',width:{ideal:1280},height:{ideal:720}},audio:false};
  const b={video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}},audio:false};
  try{ v.srcObject=await navigator.mediaDevices.getUserMedia(a); }
  catch(_){ v.srcObject=await navigator.mediaDevices.getUserMedia(b); v.style.transform=''; }
})();
function snapshotBase64(){
  const v=document.getElementById('cam'), c=document.getElementById('snap');
  const w=v.videoWidth||1280, h=v.videoHeight||720, maxW=900, sc=Math.min(1,maxW/w);
  c.width=Math.round(w*sc); c.height=Math.round(h*sc);
  const ctx=c.getContext('2d');
  ctx.save();
  const mirrored=getComputedStyle(v).transform.includes('matrix(-1');
  if(mirrored){ ctx.translate(c.width,0); ctx.scale(-1,1); }
  ctx.drawImage(v,0,0,c.width,c.height);
  ctx.restore();
  return c.toDataURL('image/jpeg',0.85);
}

/*** UI ***/
const sBox=document.getElementById('status'), sMain=document.getElementById('sMain'), sSub=document.getElementById('sSub');
function setStatus(msg,kind='info',sub=''){ sMain.textContent=msg; sSub.textContent=sub||''; sBox.classList.remove('ok','err'); if(kind==='ok') sBox.classList.add('ok'); if(kind==='err') sBox.classList.add('err'); }

/*** CHECK smart (memoria → últimas filas). Reintenta cada 200ms, timeout 6s ***/
function jsonpCheckSmart(nombre, timeoutMs=6000){
  const deadline=Date.now()+timeoutMs;
  return new Promise((resolve,reject)=>{
    const poll=()=>{
      const cb='cb'+Math.random().toString(36).slice(2);
      const s=document.createElement('script');
      const url=`${WEBAPP_URL}?check=1&nombre=${encodeURIComponent(nombre)}&t=${Date.now()}&callback=${cb}`;
      const to=setTimeout(()=>{ cleanup(); next(); }, 700);
      window[cb]=(r)=>{ cleanup(); (r&&r.ok)?resolve(r):next(); };
      s.src=url; s.onerror=()=>{ cleanup(); next(); };
      document.body.appendChild(s);
      function cleanup(){ clearTimeout(to); delete window[cb]; s.remove(); }
      function next(){ (Date.now()>=deadline)?reject(new Error('timeout')):setTimeout(poll,200); }
    };
    poll();
  });
}

/*** Fichaje ***/
async function fichar(nombreOriginal,tipo){
  const nombre = normalizeName(nombreOriginal);
  setStatus(`${nombre} — enviando…`,'info',hhmmss());

  const photoB64 = snapshotBase64();

  // POST rápido sin preflight
  try{
    await fetch(WEBAPP_URL,{
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({ nombre, tipo, photo: photoB64 })
    });
  }catch(_){}

  await new Promise(r=>setTimeout(r,250));

  try{
    const r = await jsonpCheckSmart(nombre, 6000);
    setStatus(`OK ${nombre} — ${hhmmss()} — enviado`,'ok');
    const beep=document.getElementById('beep'); beep.currentTime=0; beep.play().catch(()=>{});
  }catch(_){
    setStatus(`${nombre} — no confirmado (revisa conexión)`,'err');
  }
}
</script>
</body>
</html>
