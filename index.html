<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje — Botones por trabajador</title>
<style>
  :root{ --gap:16px; --r:18px; --w:1100px; --btnH:84px; }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; font-family:system-ui, Arial, sans-serif; background:#eef2f6; color:#111; }
  .wrap{ max-width:var(--w); margin:24px auto; padding:0 var(--gap); }
  h1{ margin:0 0 16px; font-size:28px; font-weight:800; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px var(--gap); }
  .cell{ display:flex; align-items:center; justify-content:center; height:var(--btnH);
         border-radius:16px; font-weight:800; font-size:20px; color:#fff; cursor:pointer; user-select:none;
         transition:transform .05s ease-out, filter .15s ease; text-align:center; padding:0 10px; }
  .cell:active{ transform:scale(.995); filter:brightness(.98); }
  .in { background:#1f8f44; }
  .out{ background:#c63c3c; }
  .cell[aria-busy="true"]{ position:relative; }
  .cell[aria-busy="true"]::after{
    content:"Enviando…"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.15); border-radius:inherit; font-weight:800; color:#fff;
  }
  .okflash{ box-shadow:0 0 0 3px rgba(16,185,129,.55) inset; }
  .errflash{ box-shadow:0 0 0 3px rgba(239,68,68,.65) inset; }
  .footer{ margin-top:14px; border-radius:12px; padding:10px 12px; font-weight:700; text-align:center; }
  .status-ok{ background:#e7f9ef; color:#0f6b35; }
  .status-err{ background:#fdecec; color:#a21919; }
  .note{ margin-top:8px; font-size:12px; color:#445; opacity:.8; text-align:center; }
  @media (max-width:720px){
    :root{ --btnH:72px; }
    .grid{ gap:10px; }
    .cell{ font-size:18px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje rápido</h1>

  <!-- PAREJA DE COLUMNAS: ENTRADA / SALIDA -->
  <div id="grid" class="grid" role="grid" aria-label="Botones de fichaje"></div>

  <div id="status" class="footer" hidden></div>
  <div class="note">Pulsa el botón. Sonará un beep al confirmar. Si no hay confirmación de red, se indicará abajo.</div>
</div>

<script>
/*** CONFIG ***/
const ENDPOINT = 'PON_AQUI_TU_URL_WEBAPP/exec'; // GAS Web App → “Cualquiera, incluso anónimo”
const WORKERS  = [
  'Ana López Martín',
  'Carla Gómez Torres',
  'Luis Fernández Díaz',
  'Diego Pérez Ruiz'
];

/*** AUDIO (beep) ***/
let audioUnlocked=false;
function unlockAudioOnce(){
  if (audioUnlocked) return;
  try {
    const AC = window.AudioContext||window.webkitAudioContext;
    const a  = new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination); g.gain.value=0; o.start(); o.stop(0); a.close();
    audioUnlocked=true;
  } catch(_) {}
}
function beepOk(){
  try{
    const AC = window.AudioContext||window.webkitAudioContext;
    const a  = new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination);
    o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.06, a.currentTime);
    o.start(); setTimeout(()=>{o.stop(); a.close();},120);
  }catch(_){}
}

/*** UTIL ***/
function el(tag, attrs={}, text=''){
  const n=document.createElement(tag);
  for(const k in attrs){ if(k==='class') n.className=attrs[k]; else n.setAttribute(k, attrs[k]); }
  if(text) n.textContent=text;
  return n;
}
function showStatus(msg, ok=true){
  const s = document.getElementById('status');
  s.className = 'footer ' + (ok?'status-ok':'status-err');
  s.textContent = msg;
  s.hidden = false;
}

/*** JSONP helpers ***/
function jsonp(url, onDone){
  const cb = 'cb_' + Math.random().toString(36).slice(2);
  window[cb] = (data)=>{ try{ onDone(data); } finally{ delete window[cb]; scr.remove(); } };
  const scr = el('script', { src: url + (url.includes('?')?'&':'?') + 'callback=' + cb });
  scr.onerror = ()=>{ try{ onDone({ok:false,error:'JSONP error'}); } finally{ delete window[cb]; scr.remove(); } };
  document.head.appendChild(scr);
}
function confirmReceipt(nombre, afterIso, attempts=8, delayMs=400){
  return new Promise(resolve=>{
    const step=(left)=>{
      const u = `${ENDPOINT}?check=1&nombre=${encodeURIComponent(nombre)}&after=${encodeURIComponent(afterIso)}`;
      jsonp(u, r=>{
        if(r && r.ok) return resolve(true);
        if(left>1) return setTimeout(()=>step(left-1), delayMs);
        resolve(false);
      });
    };
    step(attempts);
  });
}

/*** UI BUILD ***/
const grid = document.getElementById('grid');
WORKERS.forEach(n=>{
  // Entrada
  const inBtn  = el('div', {class:'cell in', role:'button', 'data-nombre':n, 'data-tipo':'entrada', tabindex:'0'},
                    `${n} — Entrada`);
  // Salida
  const outBtn = el('div', {class:'cell out', role:'button', 'data-nombre':n, 'data-tipo':'salida', tabindex:'0'},
                    `${n} — Salida`);
  grid.appendChild(inBtn);
  grid.appendChild(outBtn);
});

/*** CLICK HANDLER ***/
grid.addEventListener('click', onAction);
grid.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ onAction(e); e.preventDefault(); } });

function onAction(e){
  unlockAudioOnce();
  const t = e.target.closest('.cell'); if(!t) return;
  if (t.getAttribute('aria-busy')==='true') return;

  const nombre = t.getAttribute('data-nombre');
  const tipo   = t.getAttribute('data-tipo');
  const afterIso = new Date().toISOString();

  t.setAttribute('aria-busy','true');

  // FASE 1: Fichaje rápido por GET (JSONP) => OK + beep inmediato
  const url = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&sinPausa=false`;
  jsonp(url, async (r)=>{
    t.removeAttribute('aria-busy');

    if(!r || !r.ok){
      flash(t, false);
      showStatus(`${nombre} — error: ${(r && (r.msg||r.error)) || 'desconocido'}`, false);
      return;
    }

    flash(t, true);
    beepOk();
    showStatus(`${nombre} — ${tipo} OK ${r.hora}`, true);

    // FASE 2: Confirmación silenciosa (evita falsos “no confirmado”)
    const ok = await confirmReceipt(nombre, afterIso, 8, 400);
    if(!ok){
      // No machacamos el OK; solo informativo (como en tu captura).
      showStatus(`${nombre} — no confirmado (revisa conexión)`, false);
    }
  });
}

function flash(node, ok=true){
  node.classList.remove('okflash','errflash');
  node.classList.add(ok?'okflash':'errflash');
  setTimeout(()=>node.classList.remove('okflash','errflash'), 900);
}
</script>
</body>
</html>
