<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje — Cámara arriba + Botones compactos</title>
<style>
  :root{
    --gap:14px; --r:16px; --maxw:1100px;
    --btnH:64px; --btnFS:19px;
    --green:#1f8f44; --green2:#13813a;
    --red:#c63c3c;  --red2:#b03333;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; font-family:system-ui,Arial,sans-serif; background:#eef2f6; color:#0f172a; }
  .wrap{ max-width:var(--maxw); margin:18px auto 92px; padding:0 var(--gap); } /* margen inferior para el rectángulo */
  h1{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }

  /* Cámara arriba, centrada */
  .camWrap{ display:flex; justify-content:center; margin:6px 0 16px; }
  .card{ width:360px; background:#fff; border-radius:18px; box-shadow:0 10px 30px rgba(15,23,42,.08); padding:12px; }
  .card h3{ margin:0 0 8px; font-size:15px; font-weight:800; text-align:center; color:#0f172a; }
  .cam{ width:100%; aspect-ratio: 4 / 3; background:#000; border-radius:12px; overflow:hidden; }
  video,canvas{ width:100%; height:100%; display:block; }
  .hint{ margin-top:6px; font-size:12px; color:#666; text-align:center; }

  /* Botones en dos columnas compactos */
  .layout{ display:grid; grid-template-columns: 1fr 1fr; gap:12px 16px; align-items:start; }
  .col{ display:grid; grid-template-columns:1fr; gap:12px; }

  .cell{
    position:relative; display:flex; align-items:center; justify-content:center;
    height:var(--btnH); border-radius:16px; color:#fff; font-weight:800; font-size:var(--btnFS);
    user-select:none; cursor:pointer; padding:0 12px; text-align:center;
    box-shadow:0 6px 16px rgba(0,0,0,.08), inset 0 -2px 0 rgba(0,0,0,.08);
    transition:transform .06s ease, filter .12s ease, box-shadow .12s ease;
  }
  .cell:active{ transform:translateY(1px); filter:brightness(.98); }
  .in  { background:linear-gradient(180deg, var(--green), var(--green2)); }
  .out { background:linear-gradient(180deg, var(--red),   var(--red2));  }

  /* Overlay “Enviando…” */
  .cell[aria-busy="true"]::after{
    content:"Enviando…";
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.20); border-radius:inherit; font-weight:800; color:#fff;
  }
  .okflash{ box-shadow:0 0 0 3px rgba(16,185,129,.55) inset, 0 6px 16px rgba(0,0,0,.08); }
  .errflash{ box-shadow:0 0 0 3px rgba(239,68,68,.65) inset, 0 6px 16px rgba(0,0,0,.08); }

  /* Rectángulo inferior (estado) */
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    min-width:280px; max-width: min(680px, 90vw);
    padding:12px 16px; border-radius:12px; font-weight:700; text-align:center;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
  }
  .toast.ok  { background:#e7f9ef; color:#0f6b35; }
  .toast.err { background:#fdecec; color:#a21919; }
  .toast[hidden]{ display:none; }

  @media (max-width:780px){
    :root{ --btnH:58px; --btnFS:17px; }
    .card{ width:92vw; max-width:420px; }
    .layout{ grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje rápido</h1>

  <!-- CÁMARA ARRIBA, CENTRADA -->
  <div class="camWrap">
    <section class="card">
      <h3>Cámara (auto)</h3>
      <div class="cam">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas" hidden></canvas>
      </div>
      <div id="camStatus" class="hint"></div>
    </section>
  </div>

  <!-- BOTONES: IZQ ENTRADA / DCHA SALIDA -->
  <div class="layout">
    <div id="colIn"  class="col" aria-label="Entradas"></div>
    <div id="colOut" class="col" aria-label="Salidas"></div>
  </div>
</div>

<!-- Rectángulo inferior (estado) -->
<div id="toast" class="toast ok" hidden>OK</div>

<script>
/*** CONFIG ***/
const ENDPOINT = 'PON_AQUI_TU_URL_WEBAPP/exec';    // GAS Web App → “Cualquiera, incluso anónimo”
const WORKERS  = [
  'Ana López Martín',
  'Carla Gómez Torres',
  'Luis Fernández Díaz',
  'Diego Pérez Ruiz'
];
const TARGET_WIDTH = 640;   // captura rápida
const JPEG_QUALITY = 0.6;

/*** DOM ***/
const colIn  = document.getElementById('colIn');
const colOut = document.getElementById('colOut');
const toast  = document.getElementById('toast');
const video  = document.getElementById('video');
const canvas = document.getElementById('canvas');
const camStatus = document.getElementById('camStatus');

/*** AUDIO ***/
let audioUnlocked=false;
function unlockAudioOnce(){
  if (audioUnlocked) return;
  try { const AC=window.AudioContext||window.webkitAudioContext;
    const a=new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination); g.gain.value=0; o.start(); o.stop(0); a.close(); audioUnlocked=true;
  } catch(_) {}
}
function beepOk(){
  try{ const AC=window.AudioContext||window.webkitAudioContext;
    const a=new AC(); const o=a.createOscillator(); const g=a.createGain();
    o.connect(g); g.connect(a.destination); o.type='sine'; o.frequency.value=880;
    g.gain.setValueAtTime(0.06,a.currentTime); o.start(); setTimeout(()=>{o.stop();a.close();},120);
  }catch(_){}
}

/*** Cámara ***/
let camReady=false;
(async function initCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'}, audio:false });
    video.srcObject=stream;
    await video.play().catch(()=>{});
    camReady=true; camStatus.textContent='Cámara lista';
  }catch(e){
    camReady=false; camStatus.textContent='Sin acceso a cámara (se enviará sin foto)';
  }
})();
function captureToDataURL(){
  if(!camReady || !video.videoWidth || !video.videoHeight) return '';
  const vw=video.videoWidth, vh=video.videoHeight;
  const scale=TARGET_WIDTH/vw, tw=Math.round(vw*scale), th=Math.round(vh*scale);
  canvas.width=tw; canvas.height=th;
  const ctx=canvas.getContext('2d',{willReadFrequently:false});
  ctx.drawImage(video,0,0,tw,th);
  return canvas.toDataURL('image/jpeg', JPEG_QUALITY);
}

/*** Utils ***/
function el(tag, attrs={}, text=''){ const n=document.createElement(tag);
  for(const k in attrs){ if(k==='class') n.className=attrs[k]; else n.setAttribute(k, attrs[k]); }
  if(text) n.textContent=text; return n;
}
function flash(node, ok=true){ node.classList.remove('okflash','errflash'); node.classList.add(ok?'okflash':'errflash'); setTimeout(()=>node.classList.remove('okflash','errflash'), 900); }
function showToast(msg, ok=true){ toast.className='toast '+(ok?'ok':'err'); toast.textContent=msg; toast.hidden=false; }

/*** JSONP/POST ***/
function jsonp(url, onDone){
  const cb='cb_'+Math.random().toString(36).slice(2);
  window[cb]=(data)=>{ try{ onDone(data); } finally{ delete window[cb]; scr.remove(); } };
  const scr=el('script',{src:url+(url.includes('?')?'&':'?')+'callback='+cb});
  scr.onerror=()=>{ try{ onDone({ok:false,error:'JSONP error'}); } finally{ delete window[cb]; scr.remove(); } };
  document.head.appendChild(scr);
}
async function postJSON(url, payload, timeoutMs=15000){
  const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload),signal:ctrl.signal});
    return await res.json().catch(()=>({ok:false,error:'Respuesta inválida'}));
  } finally{ clearTimeout(to); }
}
function confirmReceipt(nombre, afterIso, attempts=8, delayMs=400){
  return new Promise(resolve=>{
    const step=(left)=>{
      const u=`${ENDPOINT}?check=1&nombre=${encodeURIComponent(nombre)}&after=${encodeURIComponent(afterIso)}`;
      jsonp(u, r=>{ if(r && r.ok) resolve(true); else if(left>1) setTimeout(()=>step(left-1), delayMs); else resolve(false); });
    }; step(attempts);
  });
}

/*** Botones (dos columnas) ***/
WORKERS.forEach(n=>{
  colIn.appendChild( el('div',{class:'cell in',  role:'button','data-nombre':n,'data-tipo':'entrada',tabindex:'0'},`${n} — Entrada`) );
  colOut.appendChild(el('div',{class:'cell out', role:'button','data-nombre':n,'data-tipo':'salida', tabindex:'0'},`${n} — Salida`) );
});

/*** Interacción ***/
[colIn,colOut].forEach(col=>{
  col.addEventListener('click', onClick);
  col.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ onClick(e); e.preventDefault(); } });
});

function onClick(e){
  unlockAudioOnce();
  const t=e.target.closest('.cell'); if(!t) return;
  if(t.getAttribute('aria-busy')==='true') return;

  const nombre=t.getAttribute('data-nombre');
  const tipo=t.getAttribute('data-tipo');
  const afterIso=new Date().toISOString();

  t.setAttribute('aria-busy','true'); // overlay “Enviando…”

  // Fase 1: GET rápido (JSONP) → OK + beep
  const url=`${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&sinPausa=false`;
  jsonp(url, async r=>{
    t.removeAttribute('aria-busy');

    if(!r || !r.ok){ flash(t,false); showToast(`${nombre} — error: ${(r && (r.msg||r.error))||'desconocido'}`, false); return; }

    flash(t,true);
    beepOk();
    showToast(`${nombre} — ${tipo} OK ${r.hora}`, true);

    // Fase 2: Foto en background (si hay cámara)
    try{
      const durl=captureToDataURL();
      if(durl) postJSON(ENDPOINT,{ token:r.token, photo:durl })
                .then(x=>{ if(!x.ok) console.log('Foto err:',x.error||x.msg); });
    }catch(_){}

    // Confirmación silenciosa (evita falsos “no confirmado”)
    const ok=await confirmReceipt(nombre, afterIso, 8, 400);
    if(!ok) showToast(`${nombre} — no confirmado (revisa conexión)`, false);
  });
}
</script>
</body>
</html>
